{% extends 'custom_admin/base.html' %}
{% load static %}

{% block title %}üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
    .map-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .map-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 16px;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .map-header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
    }

    .map-controls {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-group label {
        font-weight: 600;
        margin: 0;
    }

    .control-btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: 2px solid #e0e0e0;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .control-btn:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .map-wrapper {
        background: white;
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        position: relative;
    }

    #map {
        height: 600px;
        border-radius: 12px;
        z-index: 1;
    }

    .stats-overlay {
        position: absolute;
        top: 100px;
        right: 30px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 250px;
    }

    .stat-item {
        padding: 12px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã */
    .custom-marker {
        background-color: #4CAF50;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 11px;
        color: white;
    }

    .custom-marker.pending {
        background-color: #FF9800;
    }

    .custom-marker.rejected {
        background-color: #F44336;
    }

    /* üî• –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ */
    .marker-pulse {
        animation: pulse 2s infinite;
    }

    /* –ü–æ–ø–∞–ø —Å—Ç–∏–ª–∏ */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
    }

    .popup-title {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #667eea;
        font-weight: bold;
    }

    .popup-info {
        margin: 5px 0;
        font-size: 14px;
    }

    .popup-info strong {
        color: #333;
    }

    /* üî• –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ */
    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
            opacity: 1;
        }

        50% {
            transform: scale(1.15);
            opacity: 0.85;
        }
    }

    .marker-pulse {
        animation: pulse 2s ease-in-out infinite !important;
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .custom-marker:hover {
        transform: scale(1.2) !important;
        cursor: pointer;
        filter: brightness(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div class="map-header">
        <h1>üó∫Ô∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h1>
        <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤ (OpenStreetMap)</p>
    </div>

    <div class="map-controls">
        <div class="control-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="statusFilter" class="form-select" onchange="loadMapData()">
                <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                <option value="pending">–û–∂–∏–¥–∞—é—â–∏–µ</option>
                <option value="">–í—Å–µ</option>
            </select>
        </div>

        <div class="control-group">
            <label>–ì–æ—Ä–æ–¥:</label>
            <input type="text" id="cityFilter" class="form-control" placeholder="–í—Å–µ –≥–æ—Ä–æ–¥–∞" onchange="loadMapData()" onkeypress="if(event.key === 'Enter') loadMapData()">
        </div>

        <button class="control-btn" onclick="loadMapData()">
            <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å
        </button>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>

        <div class="stats-overlay">
            <div class="stat-item">
                <div class="stat-label">–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                <div class="stat-value" id="totalProjects">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤</div>
                <div class="stat-value" id="totalCities">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">–í–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤</div>
                <div class="stat-value" id="totalVolunteers">0</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    let map;
    let markers = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã OpenStreetMap
    function initMap() {
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –ê–ª–º–∞—Ç—ã
        map = L.map('map').setView([43.238949, 76.889709], 11);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π OpenStreetMap (–ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ!)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç–æ–≤
        loadMapData();
    }

    async function loadMapData() {
        const status = document.getElementById('statusFilter').value;
        const city = document.getElementById('cityFilter').value;

        try {
            let url = '/custom-admin/api/v1/map/projects-web/?';
            if (status) url += `status=${status}&`;
            if (city) url += `city=${city}&`;

            const response = await fetch(url);
            const data = await response.json();

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            let totalVolunteers = 0;
            const cities = new Set();
            const bounds = [];

            if (!data.features || data.features.length === 0) {
                document.getElementById('totalProjects').textContent = '0';
                document.getElementById('totalCities').textContent = '0';
                document.getElementById('totalVolunteers').textContent = '0';
                console.log('No projects found');
                return;
            }

            data.features.forEach(feature => {
                const coords = feature.geometry.coordinates;
                const props = feature.properties;

                // üî• –¢–ï–ü–õ–û–¢–ê: –†–∞–∑–º–µ—Ä –∏ —è—Ä–∫–æ—Å—Ç—å –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                const volunteerCount = props.volunteers_count;
                const taskCount = props.tasks_count;
                const activity = volunteerCount + taskCount; // –ú–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

                // –†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–æ—Ç 35px –¥–æ 60px)
                let markerSize = 35 + Math.min(activity * 5, 25);

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–º "—Ç–µ–ø–ª–æ—Ç—ã"
                let markerColor = '#4CAF50'; // approved - –∑–µ–ª–µ–Ω—ã–π
                let shadowColor = 'rgba(76, 175, 80, 0.6)'; // —Ç–µ–Ω—å –∑–µ–ª–µ–Ω–∞—è
                let statusClass = '';

                if (props.status === 'pending') {
                    markerColor = '#FF9800'; // –æ—Ä–∞–Ω–∂–µ–≤—ã–π
                    shadowColor = 'rgba(255, 152, 0, 0.6)';
                    statusClass = 'pending';
                } else if (props.status === 'rejected') {
                    markerColor = '#F44336'; // –∫—Ä–∞—Å–Ω—ã–π
                    shadowColor = 'rgba(244, 67, 54, 0.6)';
                    statusClass = 'rejected';
                }

                // –ü—É–ª—å—Å–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (—Å–Ω–∏–∂–µ–Ω –ø–æ—Ä–æ–≥ —Å 5 –¥–æ 3)
                let pulseClass = activity > 2 ? 'marker-pulse' : '';

                console.log(`Project: ${props.title}, Activity: ${activity}, Size: ${markerSize}px, Pulse: ${pulseClass ? 'YES' : 'NO'}`);

                // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É —Å "—Ç–µ–ø–ª–æ—Ç–æ–π"
                const glowSize = Math.min(activity * 5, 30); // –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `
                    <div class="custom-marker ${statusClass} ${pulseClass}" style="
                        background: radial-gradient(circle, ${markerColor} 0%, ${markerColor}dd 60%, ${markerColor}88 100%);
                        width: ${markerSize}px;
                        height: ${markerSize}px;
                        border: 4px solid white;
                        box-shadow: 0 0 ${glowSize}px ${shadowColor}, 0 0 ${glowSize * 0.5}px ${shadowColor}, 0 4px 10px rgba(0,0,0,0.4);
                        font-size: ${Math.max(12, Math.min(markerSize / 3, 18))}px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        font-weight: bold;
                        color: white;
                        transition: all 0.3s ease;
                    ">${volunteerCount}</div>
                `,
                    iconSize: [markerSize, markerSize],
                    iconAnchor: [markerSize / 2, markerSize / 2]
                });

                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                const marker = L.marker([coords[1], coords[0]], {
                    icon: customIcon
                }).addTo(map);

                // –°—Ç–∞—Ç—É—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º
                let statusText = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                if (props.status === 'approved') statusText = '‚úÖ –û–¥–æ–±—Ä–µ–Ω';
                else if (props.status === 'pending') statusText = '‚è≥ –û–∂–∏–¥–∞–µ—Ç';
                else if (props.status === 'rejected') statusText = '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω';

                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ø–∞–ø —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                const popupContent = `
                <div>
                    <div class="popup-title">${props.title}</div>
                    <div class="popup-info"><strong>üìç –ì–æ—Ä–æ–¥:</strong> ${props.city}</div>
                    <div class="popup-info"><strong>üéØ –°—Ç–∞—Ç—É—Å:</strong> ${statusText}</div>
                    <div class="popup-info"><strong>üë• –í–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤:</strong> ${props.volunteers_count}</div>
                    <div class="popup-info"><strong>‚úÖ –ó–∞–¥–∞—á:</strong> ${props.tasks_count}</div>
                    <div class="popup-info"><strong>üë§ –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä:</strong> ${props.creator.name}</div>
                    <div class="popup-info" style="color: #666; margin-top: 10px;">${props.description.substring(0, 150)}...</div>
                </div>
            `;

                marker.bindPopup(popupContent);

                markers.push(marker);
                bounds.push([coords[1], coords[0]]);

                totalVolunteers += props.volunteers_count;
                cities.add(props.city);
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            document.getElementById('totalProjects').textContent = data.features.length;
            document.getElementById('totalCities').textContent = cities.size;
            document.getElementById('totalVolunteers').textContent = totalVolunteers;

            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–∞—Ö
            if (bounds.length > 0) {
                if (bounds.length === 1) {
                    map.setView(bounds[0], 13);
                } else {
                    map.fitBounds(bounds, {
                        padding: [50, 50]
                    });
                }
            }

            console.log(`Loaded ${data.features.length} projects on map`);

        } catch (error) {
            console.error('Oshibka zagruzki proektov:', error);
            alert('Oshibka zagruzki dannykh karty. Proverite console (F12).');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}