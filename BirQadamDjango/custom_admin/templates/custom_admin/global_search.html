{% extends 'custom_admin/base.html' %}
{% load static %}

{% block title %}üîç –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .search-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 16px;
        color: white;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .search-box {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .search-input-wrapper {
        position: relative;
    }

    .search-input {
        width: 100%;
        padding: 18px 60px 18px 24px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-button {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .search-button:hover {
        transform: translateY(-50%) scale(1.05);
    }

    .filter-pills {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    .filter-pill {
        padding: 10px 20px;
        border-radius: 25px;
        border: 2px solid #e0e0e0;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    .filter-pill:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .filter-pill.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .results-section {
        margin-bottom: 30px;
    }

    .results-header {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .results-count {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 14px;
    }

    .result-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }

    .result-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .result-card.user {
        border-left-color: #667eea;
    }

    .result-card.project {
        border-left-color: #56ab2f;
    }

    .result-card.task {
        border-left-color: #f2994a;
    }

    .result-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .result-meta {
        color: #666;
        font-size: 14px;
    }

    .result-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
    }

    .badge-volunteer {
        background: #e3f2fd;
        color: #1976d2;
    }

    .badge-organizer {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .badge-active {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge-pending {
        background: #fff3e0;
        color: #e65100;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-state h3 {
        color: #666;
        margin-bottom: 10px;
    }

    .loading {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h1>üîç –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</h1>
        <p>–ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø—Ä–æ–µ–∫—Ç—ã –∏ –∑–∞–¥–∞—á–∏ –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ</p>
    </div>

    <div class="search-box">
        <div class="search-input-wrapper">
            <input type="text" id="searchInput" class="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞..." autocomplete="off">
            <button class="search-button" onclick="performSearch()">
                <i class="fas fa-search"></i> –ü–æ–∏—Å–∫
            </button>
        </div>

        <div class="filter-pills">
            <div class="filter-pill active" data-type="all" onclick="setFilter('all')">
                –í—Å–µ
            </div>
            <div class="filter-pill" data-type="users" onclick="setFilter('users')">
                üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </div>
            <div class="filter-pill" data-type="projects" onclick="setFilter('projects')">
                üìÅ –ü—Ä–æ–µ–∫—Ç—ã
            </div>
            <div class="filter-pill" data-type="tasks" onclick="setFilter('tasks')">
                ‚úÖ –ó–∞–¥–∞—á–∏
            </div>
        </div>
    </div>

    <div id="loadingState" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>–ü–æ–∏—Å–∫...</p>
    </div>

    <div id="resultsContainer"></div>

    <div id="emptyState" class="empty-state" style="display: none;">
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentFilter = 'all';

    function setFilter(type) {
        currentFilter = type;
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.classList.remove('active');
        });
        document.querySelector(`[data-type="${type}"]`).classList.add('active');

        const query = document.getElementById('searchInput').value;
        if (query.length >= 2) {
            performSearch();
        }
    }

    async function performSearch() {
        const query = document.getElementById('searchInput').value.trim();

        if (query.length < 2) {
            alert('–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
            return;
        }

        showLoading();

        try {
            const response = await fetch(`/custom-admin/api/v1/search/global/?q=${encodeURIComponent(query)}&type=${currentFilter}`);
            const data = await response.json();

            displayResults(data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–∞');
        }
    }

    function showLoading() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('resultsContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }

    function displayResults(data) {
        document.getElementById('loadingState').style.display = 'none';

        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';

        if (data.total === 0) {
            document.getElementById('emptyState').style.display = 'block';
            return;
        }

        container.style.display = 'block';
        document.getElementById('emptyState').style.display = 'none';

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
        if (data.users && data.users.length > 0) {
            container.innerHTML += `
            <div class="results-section">
                <div class="results-header">
                    üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                    <span class="results-count">${data.users.length}</span>
                </div>
                ${data.users.map(user => `
                    <div class="result-card user">
                        <div class="result-title">${user.name || user.username}</div>
                        <div class="result-meta">
                            <span class="result-badge badge-${user.role}">${user.role === 'volunteer' ? '–í–æ–ª–æ–Ω—Ç–µ—Ä' : '–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä'}</span>
                            üìß ${user.email} | ‚≠ê –†–µ–π—Ç–∏–Ω–≥: ${user.rating}
                            ${user.city ? `| üìç ${user.city}` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        }

        // –ü—Ä–æ–µ–∫—Ç—ã
        if (data.projects && data.projects.length > 0) {
            container.innerHTML += `
            <div class="results-section">
                <div class="results-header">
                    üìÅ –ü—Ä–æ–µ–∫—Ç—ã
                    <span class="results-count">${data.projects.length}</span>
                </div>
                ${data.projects.map(project => `
                    <div class="result-card project">
                        <div class="result-title">${project.title}</div>
                        <div class="result-meta">
                            <span class="result-badge badge-${project.status === 'approved' ? 'active' : 'pending'}">${project.status}</span>
                            üìç ${project.city} | üë• ${project.volunteers_count} –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤
                            | üë§ ${project.creator.name}
                        </div>
                        <p style="margin-top: 10px; color: #666;">${project.description}</p>
                        ${project.tags && project.tags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                ${project.tags.map(tag => `<span class="result-badge" style="background: #e0e0e0;">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        `;
        }

        // –ó–∞–¥–∞—á–∏
        if (data.tasks && data.tasks.length > 0) {
            container.innerHTML += `
            <div class="results-section">
                <div class="results-header">
                    ‚úÖ –ó–∞–¥–∞—á–∏
                    <span class="results-count">${data.tasks.length}</span>
                </div>
                ${data.tasks.map(task => `
                    <div class="result-card task">
                        <div class="result-title">${task.text}</div>
                        <div class="result-meta">
                            <span class="result-badge badge-${task.status === 'completed' ? 'active' : 'pending'}">${task.status}</span>
                            üìÅ –ü—Ä–æ–µ–∫—Ç: ${task.project.title} | üë• ${task.volunteers_count} –≤–æ–ª–æ–Ω—Ç–µ—Ä–æ–≤
                            ${task.deadline_date ? `| üìÖ ${new Date(task.deadline_date).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        }
    }

    // –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });

    // –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length >= 2) {
            searchTimeout = setTimeout(performSearch, 500);
        }
    });
</script>
{% endblock %}